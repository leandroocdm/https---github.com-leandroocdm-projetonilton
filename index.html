<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Orçamento Profissional</title>
  <link rel="icon" href="static/img/logo.webp">
  <link rel="stylesheet" href="static/styles.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>Gerador de Orçamento Profissional</h2>
    <form id="orcamentoForm">
      <fieldset>
        <legend>Detalhes do Cliente</legend>
        <label for="nomeCliente">Nome do Cliente:</label>
        <input type="text" id="nomeCliente" name="nomeCliente" required><br><br>
        
        <label for="cpfCnpjCliente">CPF/CNPJ:</label>
        <input type="text" id="cpfCnpjCliente" name="cpfCnpjCliente" maxlength="18" required><br><br>
      </fieldset>

      <fieldset>
        <legend>Detalhes do Serviço</legend>
        <label for="descricaoServico">Descrição do Serviço:</label><br>
        <textarea id="descricaoServico" name="descricaoServico" rows="6" required></textarea><br><br>

        <label for="observacoes">Observações adicionais:</label><br>
        <textarea id="observacoes" name="observacoes" rows="4"></textarea><br><br>

        <label for="valorTotal">Valor Total (R$):</label>
        <input type="number" id="valorTotal" name="valorTotal" step="0.01" required><br><br>
      </fieldset>

      <button type="submit" id="gerarPdfBtn">Gerar PDF</button>
    </form>
  </div>
  
  <div id="pdf-template" style="position: absolute; left: -9999px;"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('orcamentoForm');
    const gerarPdfBtn = document.getElementById('gerarPdfBtn');
    const pdfTemplateElement = document.getElementById('pdf-template');

    const PIX_DISCOUNT_RATE = 0.05;
    const CARD_MARKUP_RATE = 0.10;

    // ---- Validação CPF ----
    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, '');
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let soma = 0, resto;
      for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.substring(9, 10))) return false;
      soma = 0;
      for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.substring(10, 11))) return false;
      return true;
    }

    // ---- Validação CNPJ ----
    function validarCNPJ(cnpj) {
      cnpj = cnpj.replace(/[^\d]+/g, '');
      if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
      let tamanho = cnpj.length - 2;
      let numeros = cnpj.substring(0, tamanho);
      let digitos = cnpj.substring(tamanho);
      let soma = 0;
      let pos = tamanho - 7;
      for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
      }
      let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
      if (resultado != digitos.charAt(0)) return false;
      tamanho++;
      numeros = cnpj.substring(0, tamanho);
      soma = 0;
      pos = tamanho - 7;
      for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
      }
      resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
      if (resultado != digitos.charAt(1)) return false;
      return true;
    }

    // ---- SUBMIT ----
    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const valor = document.getElementById("cpfCnpjCliente").value;
      const somenteNumeros = valor.replace(/\D/g, '');
      let valido = false;
      if (somenteNumeros.length === 11) valido = validarCPF(valor);
      else if (somenteNumeros.length === 14) valido = validarCNPJ(valor);

      if (!valido) {
        alert("CPF ou CNPJ inválido. Corrija antes de gerar o PDF.");
        return;
      }

      gerarPdfBtn.disabled = true;
      gerarPdfBtn.textContent = 'Gerando PDF...';

      try {
        const { jsPDF } = window.jspdf;

        const nomeCliente = document.getElementById('nomeCliente').value;
        const cpfCnpj = document.getElementById('cpfCnpjCliente').value || 'Não informado';
        const descricaoServico = document.getElementById('descricaoServico').value;
        const observacoes = document.getElementById('observacoes').value || 'Nenhuma observação fornecida.';
        
        let valorTotal = parseFloat(document.getElementById('valorTotal').value);
        if (isNaN(valorTotal)) throw new Error('Valor inválido. Por favor, insira um número.');
        valorTotal = valorTotal.toFixed(2);

        const valorAVista = (valorTotal * (1 - PIX_DISCOUNT_RATE)).toFixed(2);
        const valorCartao = (valorTotal * (1 + CARD_MARKUP_RATE)).toFixed(2);
        const today = new Date().toLocaleDateString('pt-BR');

        // ---- Monta o template do PDF ----
        pdfTemplateElement.innerHTML = `
          <!-- SEU TEMPLATE HTML COMPLETO AQUI (mesmo que já montou antes) -->
        `;

        // ---- Renderiza para PDF ----
        const MARGIN = 5; 
        const A4_WIDTH_MM = 210;
        const A4_HEIGHT_MM = 297;
        const contentWidthMm = A4_WIDTH_MM - (2 * MARGIN);
        const contentHeightMm = A4_HEIGHT_MM - (2 * MARGIN);

        const canvas = await html2canvas(pdfTemplateElement, { scale: 3 });
        const imgData = canvas.toDataURL('image/jpeg', 1.0);

        const imgAspectRatio = canvas.width / canvas.height;
        let imgHeightCalculated = contentWidthMm / imgAspectRatio;
        let imgWidthCalculated = contentWidthMm;
        if (imgHeightCalculated > contentHeightMm) {
          imgHeightCalculated = contentHeightMm;
          imgWidthCalculated = contentHeightMm * imgAspectRatio;
        }

        const pdf = new jsPDF('p', 'mm', 'a4');
        const xPos = MARGIN + (contentWidthMm - imgWidthCalculated) / 2;
        const yPos = MARGIN;
        pdf.addImage(imgData, 'JPEG', xPos, yPos, imgWidthCalculated, imgHeightCalculated);

        // Links clicáveis
        pdf.link(xPos + imgWidthCalculated - 50, yPos + 20, 20, 20, { url: 'https://wa.me/5519983161919' });
        pdf.link(xPos + imgWidthCalculated - 25, yPos + 20, 20, 20, { url: 'https://instagram.com/moveis_planejados_nascimento' });

        pdf.save('Orçamento.pdf');
        alert('PDF gerado com sucesso!');

      } catch (error) {
        alert('Erro ao gerar o PDF: ' + error.message);
        console.error('Erro ao gerar o PDF:', error);
      } finally {
        pdfTemplateElement.innerHTML = '';
        gerarPdfBtn.disabled = false;
        gerarPdfBtn.textContent = 'Gerar PDF';
      }
    });
  });
  </script>
</body>
</html>
