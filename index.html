<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Orçamento Profissional</title>
  <link rel="icon" href="static/img/logo.webp">
  <link rel="stylesheet" href="static/styles.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>Gerador de Orçamento Profissional</h2>
    <form id="orcamentoForm">
      <fieldset>
        <legend>Detalhes do Cliente</legend>
        <label for="nomeCliente">Nome do Cliente:</label>
        <input type="text" id="nomeCliente" name="nomeCliente" required><br><br>
        
        <label for="cpfCnpjCliente">CPF/CNPJ:</label>
        <input type="text" id="cpfCnpjCliente" name="cpfCnpjCliente"><br><br>
      </fieldset>

      <fieldset>
        <legend>Detalhes do Serviço</legend>
        <label for="descricaoServico">Descrição do Serviço:</label><br>
        <textarea id="descricaoServico" name="descricaoServico" rows="6" required></textarea><br><br>

        <label for="observacoes">Observações adicionais:</label><br>
        <textarea id="observacoes" name="observacoes" rows="4"></textarea><br><br>

        <label for="valorTotal">Valor Total (R$):</label>
        <input type="number" id="valorTotal" name="valorTotal" step="0.01" required><br><br>
      </fieldset>

      <button type="submit" id="gerarPdfBtn">Gerar PDF</button>
    </form>
  </div>
  
  <div id="pdf-template" style="position: absolute; left: -9999px;">
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('orcamentoForm');
      const gerarPdfBtn = document.getElementById('gerarPdfBtn');
      const pdfTemplateElement = document.getElementById('pdf-template');

      const PIX_DISCOUNT_RATE = 0.05;
      const CARD_MARKUP_RATE = 0.05;

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        gerarPdfBtn.disabled = true;
        gerarPdfBtn.textContent = 'Gerando PDF...';

        try {
          const { jsPDF } = window.jspdf;

          const nomeCliente = document.getElementById('nomeCliente').value;
          const cpfCnpj = document.getElementById('cpfCnpjCliente').value || 'Não informado';
          const descricaoServico = document.getElementById('descricaoServico').value;
          const observacoes = document.getElementById('observacoes').value || 'Nenhuma observação fornecida.';
          
          let valorTotal = parseFloat(document.getElementById('valorTotal').value);
          if (isNaN(valorTotal)) {
            throw new Error('Valor inválido. Por favor, insira um número.');
          }
          valorTotal = valorTotal.toFixed(2);
          
          const valorAVista = (valorTotal * (1 - PIX_DISCOUNT_RATE)).toFixed(2);
          const valorCartao = (valorTotal * (1 + CARD_MARKUP_RATE)).toFixed(2);
          const today = new Date().toLocaleDateString('pt-BR');

          // Preenche o template HTML com os dados
          pdfTemplateElement.innerHTML = `
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
              .header { display: flex; justify-content: space-between; align-items: center; background-color: #f0f0f0; padding: 10px; border-radius: 5px; }
              .header-left { display: flex; align-items: center; }
              .header-left img { width: 192px; height: 192px; border-radius: 50%; margin-right: 10px; }
              .company-name { font-size: 36px; font-weight: bold; padding: 15px;}
              .company-details { font-size: 16px; font-weight: 700; padding-left: 15px;}
              .header-right { text-align: right; }
              .date { font-size: 14px; }
              .social-icons { display: flex; justify-content: flex-end; margin-top: 10px; }
              .social-icons img { width: 60px; height: 60px; margin-left: 50px; }
              .social-note { font-size: 10px; margin-top: 5px; }
              .section-title { font-size: 16px; font-weight: bold; margin-top: 20px; text-transform: uppercase; }
              .client-info { margin-top: 10px; font-size: 14px; }
              .budget-table { width: 100%; margin-top: 10px; background-color: #f0f0f0; border-radius: 5px; padding: 10px; }
              .budget-table th { text-align: left; padding-bottom: 5px; border-bottom: 1px solid #ccc; }
              .budget-table td { padding-top: 5px; }
              .payment-methods { margin-top: 20px; }
              .payment-options { display: flex; justify-content: space-between; margin-top: 10px; }
              .payment-option { width: 45%; }
              .payment-title { font-weight: bold; }
              .payment-desc { font-size: 12px; }
              .payment-value { background-color: #e0e0e0; padding: 5px; margin-top: 5px; text-align: center; font-weight: bold; }
              .pix-info { text-align: center; margin-top: 20px; font-size: 14px; }
              .pix-logo { width: 40px; height: 40px; vertical-align: middle; padding: 30px;}
              .text_pix {font-size: 36px; font-weight: bold; padding: 15px;}
            </style>
            <body>
              <div class="header">
                <div class="header-left">
                  <img src="static/img/logo.webp" alt="Logo da Empresa" class="logo">
                  <div>
                    <div class="company-name">Nilton Nascimento</div>
                    <div class="company-details">Móveis Planejados</div>
                    <div class="company-details">CNPJ: 13.744.549/0001-32</div>
                    <div class="company-details">Rua Salvador Pratta, n° 460</div>
                    <div class="company-details">(19) 9 8316-1919</div>
                    <div class="company-details">niltonjoiner@hotmail.com</div>
                  </div>
                </div>
                <div class="header-right">
                  <div class="date">Data: ${today}<br> Orçamento válido por 7 dias.</div>
                  <div class="social-icons">
                   <a href="https://wa.me/5519983161919"> <img src="static/img/ic_whatsapp.png" alt="WhatsApp"> </a>
                   <a href="https://instagram.com/moveis_planejados_nascimento?igshid=YmMyMTA2M2Y="> <img src="static/img/ic_instagram.png" alt="Instagram"> </a>
                  </div>
                  <div class="social-note">Toque no icone acima para ser direcionado</div>
                </div>
              </div>

              <div class="section-title">Cliente</div>
              <hr>
              <div class="client-info">
                <p><strong>NOME:</strong> ${nomeCliente}</p>
                <p><strong>CPF/CNPJ:</strong> ${cpfCnpj}</p>
              </div>

              <div class="section-title">Orçamento</div>
              <div class="budget-table">
                <table>
                  <thead>
                    <tr>
                      <th>Descrição</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><p>${descricaoServico}</p></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="section-title">Observações</div>
              <div class="client-info">
                <p>${observacoes}</p>
              </div>

              <div class="section-title">Formas de Pagamento</div>
              <hr>
              <div class="payment-options">
                <div class="payment-option">
                  <div class="payment-title">À Vista</div>
                  <div class="payment-desc">• Com desconto incluso</div>
                  <div class="payment-value"><strong>R$ ${valorAVista}</strong></div>
                </div>
                <div class="payment-option">
                  <div class="payment-title">Cartão</div>
                  <div class="payment-desc">• Com taxa de 5% inclusa</div>
                  <div class="payment-value"><strong>R$ ${valorCartao}</strong></div>
                </div>
              </div>

              <div class="pix-info">
                <p class="text_pix"><img src="static/img/ic_pix.png" alt="Pix Logo" class="pix-logo">Chave pix: 13.744.549/0001-32</p>
              </div>
            </body>
            </html>
          `;

 // Define a margem desejada em milímetros
          const MARGIN = 5; 

          // Largura da página A4 em mm
          const A4_WIDTH_MM = 210;
          const A4_HEIGHT_MM = 297;

          // Largura máxima disponível para o conteúdo da imagem (descontando as margens)
          const contentWidthMm = A4_WIDTH_MM - (2 * MARGIN);
          const contentHeightMm = A4_HEIGHT_MM - (2 * MARGIN);

          // Renderiza o elemento HTML em um canvas
          // Usamos uma escala alta para garantir a qualidade da imagem
          const canvas = await html2canvas(pdfTemplateElement, { scale: 3 }); // Escala 3 para alta qualidade
          const imgData = canvas.toDataURL('image/jpeg', 1.0); // Qualidade JPEG 1.0

          // Calcula a proporção da imagem do canvas
          const imgAspectRatio = canvas.width / canvas.height;

          // Calcula a altura da imagem que caberia na largura disponível
          let imgHeightCalculated = contentWidthMm / imgAspectRatio;
          let imgWidthCalculated = contentWidthMm;

          // Se a altura calculada for maior que a altura disponível, ajusta a altura
          if (imgHeightCalculated > contentHeightMm) {
              imgHeightCalculated = contentHeightMm;
              imgWidthCalculated = contentHeightMm * imgAspectRatio;
          }

          // Cria o documento jsPDF com orientação retrato e unidades em mm
          const pdf = new jsPDF('p', 'mm', 'a4');

          // Adiciona a imagem ao PDF, centralizando-a horizontalmente
          const xPos = MARGIN + (contentWidthMm - imgWidthCalculated) / 2;
          const yPos = MARGIN ;
          
          pdf.addImage(imgData, 'JPEG', xPos, yPos, imgWidthCalculated, imgHeightCalculated);



          // ADICIONANDO OS LINKS CLICÁVEIS APÓS A IMAGEM
            // É preciso ajustar as coordenadas (x, y, largura, altura) conforme o layout final
            const iconWidthMm = 20; // Aproximadamente 20mm para os ícones
            const iconHeightMm = 20;
            const yIconsMm = yPos + 20; // Posição vertical dos ícones no PDF
            
            // Posição aproximada do WhatsApp (ajuste se necessário)
            const xWhatsappMm = xPos + imgWidthCalculated - (iconWidthMm * 2) - 10;
            // Posição aproximada do Instagram (ajuste se necessário)
            const xInstagramMm = xPos + imgWidthCalculated - iconWidthMm; 

            pdf.link(xWhatsappMm, yIconsMm, iconWidthMm, iconHeightMm, { url: 'https://wa.me/5519983161919' });
            pdf.link(xInstagramMm, yIconsMm, iconWidthMm, iconHeightMm, { url: 'https://instagram.com/moveis_planejados_nascimento?igshid=YmMyMTA2M2Y=' });



          
          // Salva o documento
          pdf.save('Orçamento.pdf');

          alert('PDF gerado com sucesso!');

        } catch (error) {
          alert('Erro ao gerar o PDF: ' + error.message);
          console.error('Erro ao gerar o PDF:', error);
        } finally {
          // Limpa o conteúdo do template após a geração
          pdfTemplateElement.innerHTML = '';
          gerarPdfBtn.disabled = false;
          gerarPdfBtn.textContent = 'Gerar PDF';
        }

      });
    });
  </script>
</body>
</html>
